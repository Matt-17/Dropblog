@using Microsoft.AspNetCore.Components.Web
@using Dropblog.Services
@inject BlogApiService ApiService

<div class="post-type-selector">
    <label class="selector-label">Choose post type:</label>
    
    @if (IsLoading)
    {
        <div class="loading-container">
            <span class="spinner"></span>
            <span>Loading post types...</span>
        </div>
    }
    else if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="error-container">
            <span class="error-icon">âš ï¸</span>
            <span>@ErrorMessage</span>
            <button class="retry-btn" @onclick="LoadPostTypes">Retry</button>
        </div>
    }
    else
    {
        <div class="type-grid">
            @foreach (var postType in PostTypes)
            {
                <label class="type-option @(SelectedType == postType.Slug ? "selected" : "")" 
                       @onclick="@(() => SelectType(postType.Slug))">
                    <input type="radio" 
                           name="postType" 
                           value="@postType.Slug" 
                           checked="@(SelectedType == postType.Slug)" 
                           @onchange="@(() => SelectType(postType.Slug))" />
                    <div class="type-content">
                        @if (!string.IsNullOrEmpty(postType.Emoji))
                        {
                            <div class="type-emoji">@postType.Emoji</div>
                        }
                        else if (!string.IsNullOrEmpty(postType.IconPath))
                        {
                            <img src="@postType.IconPath" 
                                 alt="@postType.Name" 
                                 class="type-icon" />
                        }
                        else
                        {
                            <div class="type-emoji">ğŸ“</div>
                        }
                        <span class="type-text">@postType.Name</span>
                    </div>
                </label>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string SelectedType { get; set; } = "note";
    [Parameter] public EventCallback<string> SelectedTypeChanged { get; set; }

    private List<PostTypeInfo> PostTypes = new();
    private bool IsLoading = true;
    private string ErrorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadPostTypes();
    }

    private async Task LoadPostTypes()
    {
        IsLoading = true;
        ErrorMessage = "";
        StateHasChanged();

        try
        {
            var response = await ApiService.GetPostTypesAsync();
            
            if (response.Success && response.PostTypes != null)
            {
                PostTypes = response.PostTypes;
                
                // Ensure selected type is valid, fallback to first available
                if (!PostTypes.Any(pt => pt.Slug == SelectedType))
                {
                    var firstType = PostTypes.FirstOrDefault();
                    if (firstType != null)
                    {
                        SelectedType = firstType.Slug;
                        await SelectedTypeChanged.InvokeAsync(SelectedType);
                    }
                }
            }
            else
            {
                ErrorMessage = response.Message ?? "Failed to load post types";
                
                // Fallback to basic types if API fails
                PostTypes = GetFallbackPostTypes();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Network error: {ex.Message}";
            
            // Fallback to basic types if API fails
            PostTypes = GetFallbackPostTypes();
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task SelectType(string typeSlug)
    {
        SelectedType = typeSlug;
        await SelectedTypeChanged.InvokeAsync(typeSlug);
    }

    private List<PostTypeInfo> GetFallbackPostTypes()
    {
        // Fallback post types if API is unavailable
        return new List<PostTypeInfo>
        {
            new("note", "Note", "ğŸ“"),
            new("link", "Link", "ğŸ”—"),
            new("comment", "Comment", "ğŸ’¬"),
            new("quote", "Quote", "ğŸ’­"),
            new("photo", "Photo", "ğŸ“·"),
            new("code", "Code", "ğŸ’»"),
            new("question", "Question", "â“"),
            new("shopping", "Shopping", "ğŸ›’"),
            new("rant", "Rant", "ğŸ˜¤"),
            new("poll", "Poll", "ğŸ“Š"),
            new("media", "Media", "ğŸµ"),
            new("book", "Book", "ğŸ“š"),
            new("announcement", "Announcement", "ğŸ“¢"),
            new("calendar", "Calendar", "ğŸ“…")
        };
    }
} 